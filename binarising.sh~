#!/bin/sh

# To speed up process by making binarised model
# Converting phrase table to binary form

mkdir ~/working/binarised-model

~/mosesdecoder/bin/processPhraseTableMin -in ~/lm/train/model/phrase-table.gz -nscores 4 -out ~/working/binarised-model/phrase-table

~/mosesdecoder/bin/processLexicalTableMin -in ~/lm/train/model/reordering-table.wbe-msd-bidirectional-fe.gz -out ~/working/binarised-model/reordering-table


#Settings to run binarised model
# taking moses.ini generated by tuning with proper weights
cp ~/working/mert-work/moses.ini ~/working/binarised-model/

#Running moses on input file using binarised model

: ' Comments
 For running binarised-model of moses:
Then make a copy of the ~/working/mert-work/moses.ini in the binarised-model directory
and change the phrase and reordering tables to point to the binarised versions, as follows:
1. Change PhraseDictionaryMemory to PhraseDictionaryCompact
2. Set the path of the PhraseDictionary feature to point to $HOME/working/binarised-model/phrase-table
3. Set the path of the LexicalReordering feature to point to $HOME/working/binarised-model/reordering-table

Run on terminal:
~/mosesdecoder/bin/moses -f ~/working/binarised-model/moses.ini
'

# To make above changes in moses.ini file
sed -i 's/PhraseDictionaryMemory/PhraseDictionaryCompact/g' ~/working/binarised-model/moses.ini

sed -i 's/lm\/train\/model/working\/binarised-model/g' ~/working/binarised-model/moses.ini

sed -i 's/phrase-table.gz/phrase-table/g' ~/working/binarised-model/moses.ini

sed -i 's/reordering-table.wbe-msd-bidirectional-fe.gz/reordering-table/g' ~/working/binarised-model/moses.ini

# Running moses on input file to do translation

~/mosesdecoder/bin/moses -f ~/working/binarised-model/moses.ini < input_file_lowercase.txt > output_file_lowercase_binarised.txt


echo "BINARISED MODEL SUCCESSFULLY"



# Filter the model for this test set, meaning that we only retain the entries needed translate the test set. This will make the translation a lot faster.

rm -r filtered

~/mosesdecoder/scripts/training/filter-model-given-input.pl filtered mert-work/moses.ini ~/corpus/nl_file.true.en -Binarizer ~/mosesdecoder/bin/processPhraseTableMin

~/mosesdecoder/bin/moses -f ~/working/filtered/moses.ini < ~/working/input_file_lowercase.txt > ~/working/output_file_lowercase_filtered.txt 2> ~/working/filtered.out

~/mosesdecoder/scripts/generic/multi-bleu.perl -lc ~/corpus/nl_file.true.en < ~/working/nl_file.translated.en


echo "FILTERED MODEL WORKED"

