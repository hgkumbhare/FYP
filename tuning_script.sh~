#!/bin/sh
#tuning script

#The end result of tuning is an ini file with trained weights, which should be in ~/working/mert-work/moses.ini
# To check errors see mert.out

~/mosesdecoder/scripts/tokenizer/tokenizer.perl -l en < ~/corpusn/l_file_tuning.en > ~/corpus/nl_file_tuning.tok.en

~/mosesdecoder/scripts/tokenizer/tokenizer.perl -l en < ~/corpus/se_file_tuning.en > ~/corpus/se_file_tuning.tok.en

# Note we made "truecase-model.en" as "~/corpus/truecase-model_nl.en"
~/mosesdecoder/scripts/recaser/truecase.perl --model ~/corpus/truecase-model_nl.en < ~/corpus/nl_file_tuning.tok.en > ~/corpus/nl_file_tuning.true.en


~/mosesdecoder/scripts/recaser/truecase.perl --model ~/corpus/truecase-model_se.en < ~/corpus/se_file_tuning.tok.en > ~/corpus/se_file_tuning.true.en

~/mosesdecoder/scripts/training/mert-moses.pl ~/corpus/se_file_tuning.true.en ~/corpus/nl_file_tuning.true.en ~/mosesdecoder/bin/moses ~/lm/train/model/moses.ini --mertdir ~/mosesdecoder/bin/ &> ~/working/mert.out &

#how to add this line for speed
#echo `--decoder-flags="threads 4"`

echo "TUNING SCRIPT RAN SUCCESSFULLY"

#Make input file lowercase
~/mosesdecoder/scripts/tokenizer/lowercase.perl -l en < ~/working/input_file.txt > ~/working/input_file_lowercase.txt

# Running or Testing moses (not needed now because we using binarised form)
#~/mosesdecoder/bin/moses -f ~/working/mert-work/moses.ini < ~/working/input_file_lowercase.txt > ~/working/output_file_lowercase.txt







# To speed up process by making binarised model
# Converting phrase table to binary form

mkdir ~/working/binarised-model

~/mosesdecoder/bin/processPhraseTableMin -in ~/lm/train/model/phrase-table.gz -nscores 4 -out ~/working/binarised-model/phrase-table

~/mosesdecoder/bin/processLexicalTableMin -in ~/lm/train/model/reordering-table.wbe-msd-bidirectional-fe.gz -out ~/working/binarised-model/reordering-table


#Settings to run binarised model
# taking moses.ini generated by tuning with proper weights
cp ~/working/mert-work/moses.ini ~/working/binarised-model/

#Running moses on input file using binarised model

: ' Comments
 For running binarised-model of moses:
Then make a copy of the ~/working/mert-work/moses.ini in the binarised-model directory
and change the phrase and reordering tables to point to the binarised versions, as follows:
1. Change PhraseDictionaryMemory to PhraseDictionaryCompact
2. Set the path of the PhraseDictionary feature to point to $HOME/working/binarised-model/phrase-table
3. Set the path of the LexicalReordering feature to point to $HOME/working/binarised-model/reordering-table

Run on terminal:
~/mosesdecoder/bin/moses -f ~/working/binarised-model/moses.ini
'

# To make above changes in moses.ini file
sed -i 's/PhraseDictionaryMemory/PhraseDictionaryCompact/g' ~/working/binarised-model/moses.ini

sed -i 's/lm\/train\/model/working\/binarised-model/g' ~/working/binarised-model/moses.ini

sed -i 's/phrase-table.gz/phrase-table/g' ~/working/binarised-model/moses.ini

sed -i 's/reordering-table.wbe-msd-bidirectional-fe.gz/reordering-table/g' ~/working/binarised-model/moses.ini

# Running moses on input file to do translation

~/mosesdecoder/bin/moses -f ~/working/binarised-model/moses.ini < input_file_lowercase.txt > output_file_lowercase_binarised.txt


echo "BINARISED MODEL SUCCESSFULLY"



# Filter the model for this test set, meaning that we only retain the entries needed translate the test set. This will make the translation a lot faster.

rm -r filtered-nl_file

~/mosesdecoder/scripts/training/filter-model-given-input.pl filtered-nl_file mert-work/moses.ini ~/corpus/nl_file.true.en -Binarizer ~/mosesdecoder/bin/processPhraseTableMin

nohup nice ~/mosesdecoder/bin/moses -f ~/working/filtered-nl_file/moses.ini < ~/corpus/nl_file.true.en > ~/working/nl_file.translated.en 2> ~/working/nl_file.out

~/mosesdecoder/scripts/generic/multi-bleu.perl -lc ~/corpus/nl_file.true.en < ~/working/nl_file.translated.en


echo "FILTERED MODEL WORKED"

